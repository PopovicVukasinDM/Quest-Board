<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Board - D&D Session Scheduler</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --parchment: #f4e4bc;
            --parchment-dark: #e8d4a8;
            --parchment-light: #faf3e3;
            --ink: #2c1810;
            --ink-light: #4a3728;
            --gold: #c9a227;
            --gold-light: #e8c547;
            --available: #4a7c59;
            --available-light: #6b9b7a;
            --unavailable: #8b4049;
            --partial: #b8860b;
            --shadow: rgba(44, 24, 16, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', Georgia, serif;
            background: 
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E"),
                linear-gradient(135deg, #1a0f0a 0%, #2d1f15 50%, #1a0f0a 100%);
            min-height: 100vh;
            color: var(--ink);
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: 
                linear-gradient(to bottom, rgba(244, 228, 188, 0.95), rgba(232, 212, 168, 0.95));
            border: 3px solid var(--ink);
            border-radius: 4px;
            box-shadow: 
                0 4px 20px var(--shadow),
                inset 0 0 60px rgba(44, 24, 16, 0.1);
            position: relative;
        }

        .header::before {
            content: '‚öîÔ∏è';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            background: var(--parchment);
            padding: 0 1rem;
        }

        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--ink);
            text-shadow: 2px 2px 0 var(--gold);
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .header h1 a {
            color: inherit;
            text-decoration: none;
        }

        .header p {
            font-size: 1.1rem;
            font-style: italic;
            color: var(--ink-light);
        }

        .header-right {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--ink);
            color: var(--parchment);
            padding: 0.4rem 0.8rem;
            border-radius: 3px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-badge:hover {
            background: var(--ink-light);
        }

        .user-badge img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }

        .top-controls {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .toggle-group label {
            color: var(--ink-light);
        }

        .toggle-btn {
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
            border: 1px solid var(--ink);
            background: var(--parchment-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn:first-of-type {
            border-radius: 3px 0 0 3px;
        }

        .toggle-btn:last-of-type {
            border-radius: 0 3px 3px 0;
        }

        .toggle-btn.active {
            background: var(--ink);
            color: var(--parchment);
        }

        .toggle-btn:hover:not(.active) {
            background: var(--parchment-dark);
        }

        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .header h1 { font-size: 1.8rem; }
            .header-right { position: static; margin-top: 1rem; justify-content: center; }
        }

        .panel {
            background: 
                linear-gradient(to bottom, rgba(244, 228, 188, 0.97), rgba(232, 212, 168, 0.97));
            border: 2px solid var(--ink);
            border-radius: 4px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .panel h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--ink);
            border-bottom: 2px solid var(--gold);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: var(--ink);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.6rem;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            border: 1px solid var(--ink-light);
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.7);
            color: var(--ink);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 5px var(--gold-light);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.7rem 1.2rem;
            border: 2px solid var(--ink);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--gold);
            color: var(--ink);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--gold-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow);
        }

        .btn-secondary {
            background: var(--parchment);
            color: var(--ink);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--parchment-dark);
        }

        .btn-success {
            background: var(--available);
            color: white;
            border-color: var(--available);
        }

        .btn-success:hover:not(:disabled) {
            background: var(--available-light);
        }

        .btn-danger {
            background: var(--unavailable);
            color: white;
            border-color: var(--unavailable);
        }

        .btn-block {
            width: 100%;
        }

        .btn-small {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
        }

        .participant-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--ink);
            color: var(--parchment);
            padding: 0.3rem 0.7rem;
            border-radius: 3px;
            margin: 0.2rem;
            font-size: 0.9rem;
        }

        .participant-tag img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }

        .participant-tag.active {
            background: var(--gold);
            color: var(--ink);
        }

        .schedule-grid {
            overflow-x: auto;
            user-select: none;
        }

        .grid-container {
            display: grid;
            gap: 2px;
            min-width: fit-content;
        }

        .month-header {
            font-family: 'Cinzel', serif;
            font-weight: 400;
            text-align: center;
            padding: 0.4rem;
            background: var(--ink);
            color: var(--parchment);
            font-size: 1.1rem;
            opacity: 0.7;
            letter-spacing: 0.1em;
        }

        .grid-header {
            text-align: center;
            padding: 0.4rem 0.2rem;
            background: var(--ink);
            color: var(--parchment);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 70px;
        }

        .grid-header .day-name {
            font-family: 'Crimson Text', serif;
            font-size: 0.75rem;
            font-weight: 400;
            opacity: 0.85;
            text-transform: capitalize;
        }

        .grid-header .day-number {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .time-label {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            padding: 0.3rem 0.5rem;
            background: var(--ink);
            color: var(--parchment);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
        }

        .time-label .hour {
            font-size: 1rem;
        }

        .time-label .ampm {
            font-size: 0.65rem;
            margin-left: 1px;
            opacity: 0.8;
        }

        .time-slot {
            min-width: 70px;
            min-height: 40px;
            border: 1px solid var(--ink-light);
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-slot:hover {
            transform: scale(1.03);
            z-index: 10;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .time-slot.empty { background: rgba(255, 255, 255, 0.5); }
        .time-slot.level-1 { background: #a8d5a2; }
        .time-slot.level-2 { background: #7bc47a; }
        .time-slot.level-3 { background: #4a9f4a; }
        .time-slot.level-4 { background: #2d7d2d; }
        .time-slot.level-5 { background: var(--available); }
        .time-slot.available { background: var(--available); }
        .time-slot.dragging { background: var(--available-light); }

        .time-slot.has-note::after {
            content: 'üìú';
            position: absolute;
            top: 1px;
            right: 1px;
            font-size: 0.6rem;
        }

        .availability-count {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 0.85rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .legend {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--ink-light);
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border: 1px solid var(--ink);
            border-radius: 2px;
        }

        .tooltip {
            position: fixed;
            background: var(--ink);
            color: var(--parchment);
            padding: 1rem;
            border-radius: 4px;
            max-width: 280px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            pointer-events: none;
        }

        .tooltip h4 {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--gold);
        }

        .tooltip-entry {
            margin: 0.5rem 0;
            padding-left: 0.5rem;
            border-left: 2px solid var(--gold);
        }

        .tooltip-name { font-weight: 600; }

        .tooltip-note {
            font-style: italic;
            font-size: 0.9rem;
            color: var(--parchment-dark);
            margin-top: 0.2rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal {
            background: var(--parchment);
            border: 3px solid var(--ink);
            border-radius: 4px;
            padding: 2rem;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            font-family: 'Cinzel', serif;
            margin-bottom: 1rem;
            color: var(--ink);
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .view-toggle .btn {
            flex: 1;
            font-size: 0.75rem;
            padding: 0.5rem 0.3rem;
        }

        .view-toggle .btn.active {
            background: var(--ink);
            color: var(--parchment);
        }

        .instructions {
            background: rgba(201, 162, 39, 0.2);
            border: 1px solid var(--gold);
            border-radius: 4px;
            padding: 0.8rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .instructions strong {
            display: block;
            margin-bottom: 0.4rem;
        }

        .instructions ul {
            margin: 0;
            padding-left: 1.2rem;
        }

        .instructions li {
            margin: 0.3rem 0;
        }

        .share-box {
            background: var(--parchment-light);
            border: 2px dashed var(--gold);
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .share-url {
            font-family: monospace;
            font-size: 0.85rem;
            background: white;
            padding: 0.5rem;
            border-radius: 3px;
            word-break: break-all;
            margin: 0.5rem 0;
            display: block;
        }

        .center-panel {
            max-width: 600px;
            margin: 0 auto;
        }

        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin: 1rem 0;
        }

        .date-picker-header {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            text-align: center;
            padding: 0.3rem;
            color: var(--ink-light);
        }

        .date-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--ink-light);
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
        }

        .date-cell:hover { background: var(--parchment-dark); }
        .date-cell.selected { background: var(--available); color: white; }
        .date-cell.disabled { opacity: 0.3; cursor: not-allowed; }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .month-nav button {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.3rem 0.6rem;
        }

        .month-nav span {
            font-family: 'Cinzel', serif;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-style: italic;
            color: var(--ink-light);
        }

        .error-message {
            background: #ffebee;
            border: 1px solid var(--unavailable);
            color: var(--unavailable);
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .success-message {
            background: #e8f5e9;
            border: 1px solid var(--available);
            color: var(--available);
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .saved-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--available);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            font-family: 'Cinzel', serif;
            box-shadow: 0 4px 15px var(--shadow);
            animation: fadeInOut 2s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        .landing-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .landing-card {
            background: var(--parchment-light);
            border: 2px solid var(--ink-light);
            border-radius: 4px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .landing-card:hover {
            border-color: var(--gold);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .landing-card .icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .landing-card h3 {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .landing-card p {
            font-size: 0.85rem;
            color: var(--ink-light);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--gold);
        }

        .profile-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--ink);
            object-fit: cover;
            background: var(--parchment-dark);
        }

        .profile-image-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--ink);
            background: var(--parchment-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }

        .profile-info h2 {
            border: none;
            padding: 0;
            margin: 0;
        }

        .profile-info p {
            color: var(--ink-light);
            font-size: 0.9rem;
        }

        .adventurer-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--parchment-light);
            border: 1px solid var(--ink-light);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }

        .adventurer-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--ink);
        }

        .adventurer-card .no-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--ink);
            color: var(--parchment);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 2px solid var(--ink);
        }

        .adventurer-card .info {
            flex: 1;
        }

        .adventurer-card .name {
            font-family: 'Cinzel', serif;
            font-weight: 600;
        }

        .adventurer-card .actions {
            display: flex;
            gap: 0.5rem;
        }

        .event-list-item {
            display: block;
            background: var(--parchment-light);
            border: 1px solid var(--ink-light);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            text-decoration: none;
            color: var(--ink);
            transition: all 0.2s;
        }

        .event-list-item:hover {
            border-color: var(--gold);
            background: var(--parchment);
        }

        .event-list-item h4 {
            font-family: 'Cinzel', serif;
            margin-bottom: 0.3rem;
        }

        .event-list-item p {
            font-size: 0.85rem;
            color: var(--ink-light);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--ink-light);
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.7rem 1.2rem;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--ink-light);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--ink);
        }

        .tab.active {
            color: var(--ink);
            border-bottom-color: var(--gold);
        }

        .image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .image-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--ink);
        }

        .image-preview-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px dashed var(--ink-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--ink-light);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, createContext, useContext } = React;

        const AuthContext = createContext(null);
        function useAuth() { return useContext(AuthContext); }

        const translations = {
            en: {
                questBoard: "Quest Board",
                tagline: "Schedule your next adventure with your party",
                timeFormat: "Time",
                language: "Language",
                createNewQuest: "Create New Quest",
                eventName: "Event Name",
                eventNamePlaceholder: "e.g., D&D Session 3",
                description: "Description (optional)",
                descriptionPlaceholder: "e.g., Continuing the Velhmael campaign...",
                selectDates: "Select Possible Dates",
                selected: "selected",
                startTime: "Start Time",
                endTime: "End Time",
                createQuestBoard: "Create Quest Board",
                creating: "Creating...",
                adventurer: "Adventurer",
                joinQuest: "Join Quest",
                joinPrompt: "Join the quest to mark your availability",
                group: "Group",
                edit: "Edit",
                party: "Party",
                noAdventurers: "No adventurers yet",
                inviteParty: "Invite your party!",
                copyLink: "Copy Link",
                copied: "Copied!",
                all: "All",
                most: "Most",
                some: "Some",
                available: "Available",
                hasNote: "Has note",
                enterName: "Enter Your Name",
                howShouldPartyKnow: "How should the party know you?",
                yourName: "Your name...",
                cancel: "Cancel",
                addNote: "Add a Note",
                yourNote: "Your note",
                notePlaceholder: "e.g., Joining remotely, might need a dinner break...",
                saveNote: "Save Note",
                saved: "Saved!",
                noOneAvailable: "No one available yet",
                eventNotFound: "Event not found",
                loadingDice: "Rolling for initiative...",
                instructionsTitle: "Instructions:",
                instruction1: "Click slots to mark availability",
                instruction2: "Right-click (or long-press) available slots to add notes",
                instruction3: "Notes appear as üìú icons",
                months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                daysShort: ["S", "M", "T", "W", "T", "F", "S"],
                ordinal: (n) => { const s = ["th", "st", "nd", "rd"]; const v = n % 100; return n + (s[(v - 20) % 10] || s[v] || s[0]); },
                atTime: "at",
                welcome: "Welcome, Adventurer!",
                whatToDo: "What would you like to do?",
                login: "Login",
                register: "Register",
                createEvent: "Create Event",
                joinEvent: "Join Event",
                loginDesc: "Access your profile",
                registerDesc: "Create a new account",
                createEventDesc: "Start a new quest board",
                joinEventDesc: "Join with a link",
                username: "Username",
                password: "Password",
                displayName: "Display Name",
                loginTitle: "Login to Quest Board",
                registerTitle: "Create Your Account",
                loggingIn: "Logging in...",
                registering: "Creating account...",
                logout: "Logout",
                profile: "Profile",
                myProfile: "My Profile",
                myAdventurers: "My Adventurers",
                myQuestBoards: "My Quest Boards",
                createdByMe: "Created by Me",
                participating: "Participating In",
                changePassword: "Change Password",
                currentPassword: "Current Password",
                newPassword: "New Password",
                updateProfile: "Update Profile",
                passwordChanged: "Password changed successfully!",
                profileUpdated: "Profile updated!",
                createAdventurer: "Create Adventurer",
                editAdventurer: "Edit Adventurer",
                adventurerName: "Adventurer Name",
                adventurerImage: "Adventurer Image (URL)",
                deleteAdventurer: "Delete",
                noAdventurersSaved: "No adventurers saved yet",
                selectAdventurer: "Select an Adventurer",
                orEnterName: "Or enter a name manually",
                useAdventurer: "Use This Adventurer",
                joinEventTitle: "Join a Quest Board",
                pasteLink: "Paste the link your friend sent you",
                eventLink: "Event Link",
                go: "Go",
                profileImage: "Profile Image (URL)",
                save: "Save",
            },
            sr: {
                questBoard: "Tabla Zadataka",
                tagline: "Zaka≈æite svoju sledeƒáu avanturu sa svojom dru≈æinom",
                timeFormat: "Vreme",
                language: "Jezik",
                createNewQuest: "Kreiraj Novi Zadatak",
                eventName: "Naziv Dogaƒëaja",
                eventNamePlaceholder: "npr., D&D Sesija 3",
                description: "Opis (opciono)",
                descriptionPlaceholder: "npr., Nastavljamo Velhmael kampanju...",
                selectDates: "Izaberi Moguƒáe Datume",
                selected: "izabrano",
                startTime: "Poƒçetak",
                endTime: "Kraj",
                createQuestBoard: "Kreiraj Tablu",
                creating: "Kreiranje...",
                adventurer: "Avanturista",
                joinQuest: "Pridru≈æi se",
                joinPrompt: "Pridru≈æi se zadatku da oznaƒçi≈° dostupnost",
                group: "Grupa",
                edit: "Izmeni",
                party: "Dru≈æina",
                noAdventurers: "Jo≈° nema avanturista",
                inviteParty: "Pozovi dru≈æinu!",
                copyLink: "Kopiraj Link",
                copied: "Kopirano!",
                all: "Svi",
                most: "Veƒáina",
                some: "Neki",
                available: "Dostupan",
                hasNote: "Ima bele≈°ku",
                enterName: "Unesi Svoje Ime",
                howShouldPartyKnow: "Kako da te dru≈æina zove?",
                yourName: "Tvoje ime...",
                cancel: "Otka≈æi",
                addNote: "Dodaj Bele≈°ku",
                yourNote: "Tvoja bele≈°ka",
                notePlaceholder: "npr., Prikljuƒçujem se online, mo≈æda ƒáu imati pauzu za veƒçeru...",
                saveNote: "Saƒçuvaj",
                saved: "Saƒçuvano!",
                noOneAvailable: "Niko jo≈° nije dostupan",
                eventNotFound: "Dogaƒëaj nije pronaƒëen",
                loadingDice: "Bacamo kockice...",
                instructionsTitle: "Uputstva:",
                instruction1: "Klikni na polja da oznaƒçi≈° dostupnost",
                instruction2: "Desni klik (ili dugi pritisak) na dostupna polja za bele≈°ke",
                instruction3: "Bele≈°ke se prikazuju kao üìú ikone",
                months: ["Januar", "Februar", "Mart", "April", "Maj", "Jun", "Jul", "Avgust", "Septembar", "Oktobar", "Novembar", "Decembar"],
                days: ["Nedelja", "Ponedeljak", "Utorak", "Sreda", "ƒåetvrtak", "Petak", "Subota"],
                daysShort: ["N", "P", "U", "S", "ƒå", "P", "S"],
                ordinal: (n) => n + ".",
                atTime: "u",
                welcome: "Dobrodo≈°li, Avanturisto!",
                whatToDo: "≈†ta ≈æelite da uradite?",
                login: "Prijava",
                register: "Registracija",
                createEvent: "Kreiraj Dogaƒëaj",
                joinEvent: "Pridru≈æi se",
                loginDesc: "Pristupite svom profilu",
                registerDesc: "Napravite novi nalog",
                createEventDesc: "Zapoƒçnite novu tablu",
                joinEventDesc: "Pridru≈æite se putem linka",
                username: "Korisniƒçko ime",
                password: "Lozinka",
                displayName: "Ime za prikaz",
                loginTitle: "Prijavite se",
                registerTitle: "Kreirajte nalog",
                loggingIn: "Prijavljivanje...",
                registering: "Kreiranje naloga...",
                logout: "Odjava",
                profile: "Profil",
                myProfile: "Moj Profil",
                myAdventurers: "Moji Avanturisti",
                myQuestBoards: "Moje Table",
                createdByMe: "Moje kreacije",
                participating: "Uƒçestvujem u",
                changePassword: "Promeni lozinku",
                currentPassword: "Trenutna lozinka",
                newPassword: "Nova lozinka",
                updateProfile: "A≈æuriraj profil",
                passwordChanged: "Lozinka promenjena!",
                profileUpdated: "Profil a≈æuriran!",
                createAdventurer: "Kreiraj Avanturistu",
                editAdventurer: "Izmeni Avanturistu",
                adventurerName: "Ime Avanturiste",
                adventurerImage: "Slika Avanturiste (URL)",
                deleteAdventurer: "Obri≈°i",
                noAdventurersSaved: "Nema saƒçuvanih avanturista",
                selectAdventurer: "Izaberi Avanturistu",
                orEnterName: "Ili unesi ime ruƒçno",
                useAdventurer: "Koristi ovog Avanturistu",
                joinEventTitle: "Pridru≈æi se Tabli",
                pasteLink: "Nalepi link koji ti je prijatelj poslao",
                eventLink: "Link dogaƒëaja",
                go: "Idi",
                profileImage: "Slika profila (URL)",
                save: "Saƒçuvaj",
            }
        };

        function getSlotKey(date, hour) { return `${date}-${hour}`; }

        async function api(endpoint, options = {}) {
            const token = localStorage.getItem('quest-board-token');
            const headers = { 'Content-Type': 'application/json', ...(token && { 'Authorization': `Bearer ${token}` }) };
            const res = await fetch(endpoint, { ...options, headers });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Request failed');
            return data;
        }

        function App() {
            const [route, setRoute] = useState({ page: 'home', params: {} });
            const [lang, setLang] = useState(() => localStorage.getItem('quest-board-lang') || 'en');
            const [timeFormat, setTimeFormat] = useState(() => localStorage.getItem('quest-board-time') || '12');
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const t = translations[lang];

            useEffect(() => { localStorage.setItem('quest-board-lang', lang); }, [lang]);
            useEffect(() => { localStorage.setItem('quest-board-time', timeFormat); }, [timeFormat]);

            useEffect(() => {
                async function checkAuth() {
                    const token = localStorage.getItem('quest-board-token');
                    if (token) {
                        try { const data = await api('/api/auth/me'); setUser(data.user); } 
                        catch { localStorage.removeItem('quest-board-token'); }
                    }
                    setAuthLoading(false);
                }
                checkAuth();
            }, []);

            useEffect(() => {
                function handleRoute() {
                    const path = window.location.pathname;
                    if (path.startsWith('/event/')) setRoute({ page: 'event', params: { eventId: path.split('/event/')[1] } });
                    else if (path === '/create') setRoute({ page: 'create', params: {} });
                    else if (path === '/profile') setRoute({ page: 'profile', params: {} });
                    else if (path === '/join') setRoute({ page: 'join', params: {} });
                    else setRoute({ page: 'home', params: {} });
                }
                handleRoute();
                window.addEventListener('popstate', handleRoute);
                return () => window.removeEventListener('popstate', handleRoute);
            }, []);

            const navigate = (path) => { window.history.pushState({}, '', path); window.dispatchEvent(new PopStateEvent('popstate')); };
            const login = (token, userData) => { localStorage.setItem('quest-board-token', token); setUser(userData); };
            const logout = async () => { try { await api('/api/auth/logout', { method: 'POST' }); } catch {} localStorage.removeItem('quest-board-token'); setUser(null); navigate('/'); };

            if (authLoading) return <div className="app-container"><div className="panel loading">üé≤ {t.loadingDice}</div></div>;

            return (
                <AuthContext.Provider value={{ user, setUser, login, logout, t, lang, timeFormat }}>
                    <div className="app-container">
                        <header className="header">
                            {user && (
                                <div className="header-right">
                                    <div className="user-badge" onClick={() => navigate('/profile')}>
                                        {user.profileImage ? <img src={user.profileImage} alt="" /> : <span>üë§</span>}
                                        {user.displayName}
                                    </div>
                                    <button className="btn btn-small btn-secondary" onClick={logout}>{t.logout}</button>
                                </div>
                            )}
                            <h1><a href="/" onClick={(e) => { e.preventDefault(); navigate('/'); }}>{t.questBoard}</a></h1>
                            <p>{t.tagline}</p>
                            <div className="top-controls">
                                <div className="toggle-group">
                                    <label>{t.timeFormat}:</label>
                                    <button className={`toggle-btn ${timeFormat === '12' ? 'active' : ''}`} onClick={() => setTimeFormat('12')}>12h</button>
                                    <button className={`toggle-btn ${timeFormat === '24' ? 'active' : ''}`} onClick={() => setTimeFormat('24')}>24h</button>
                                </div>
                                <div className="toggle-group">
                                    <label>{t.language}:</label>
                                    <button className={`toggle-btn ${lang === 'en' ? 'active' : ''}`} onClick={() => setLang('en')}>EN</button>
                                    <button className={`toggle-btn ${lang === 'sr' ? 'active' : ''}`} onClick={() => setLang('sr')}>SR</button>
                                </div>
                            </div>
                        </header>
                        {route.page === 'home' && <LandingPage navigate={navigate} t={t} />}
                        {route.page === 'create' && <CreateEventPage navigate={navigate} t={t} lang={lang} timeFormat={timeFormat} />}
                        {route.page === 'join' && <JoinEventPage navigate={navigate} t={t} />}
                        {route.page === 'profile' && <ProfilePage navigate={navigate} t={t} />}
                        {route.page === 'event' && <EventPage eventId={route.params.eventId} t={t} lang={lang} timeFormat={timeFormat} />}
                    </div>
                </AuthContext.Provider>
            );
        }

        function LandingPage({ navigate, t }) {
            const { user } = useAuth();
            const [showLogin, setShowLogin] = useState(false);
            const [showRegister, setShowRegister] = useState(false);

            return (
                <div className="center-panel">
                    <div className="panel">
                        <h2>üè∞ {t.welcome}</h2>
                        <p style={{ marginBottom: '1.5rem', color: 'var(--ink-light)' }}>{t.whatToDo}</p>
                        <div className="landing-options">
                            {!user ? (
                                <>
                                    <div className="landing-card" onClick={() => setShowLogin(true)}><div className="icon">üîë</div><h3>{t.login}</h3><p>{t.loginDesc}</p></div>
                                    <div className="landing-card" onClick={() => setShowRegister(true)}><div className="icon">üìù</div><h3>{t.register}</h3><p>{t.registerDesc}</p></div>
                                </>
                            ) : (
                                <div className="landing-card" onClick={() => navigate('/profile')}><div className="icon">üë§</div><h3>{t.myProfile}</h3><p>{t.loginDesc}</p></div>
                            )}
                            <div className="landing-card" onClick={() => navigate('/create')}><div className="icon">‚öîÔ∏è</div><h3>{t.createEvent}</h3><p>{t.createEventDesc}</p></div>
                            <div className="landing-card" onClick={() => navigate('/join')}><div className="icon">üé≠</div><h3>{t.joinEvent}</h3><p>{t.joinEventDesc}</p></div>
                        </div>
                    </div>
                    {showLogin && <LoginModal onClose={() => setShowLogin(false)} t={t} />}
                    {showRegister && <RegisterModal onClose={() => setShowRegister(false)} t={t} />}
                </div>
            );
        }

        function LoginModal({ onClose, t }) {
            const { login } = useAuth();
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                try { const data = await api('/api/auth/login', { method: 'POST', body: JSON.stringify({ username, password }) }); login(data.token, data.user); onClose(); } 
                catch (err) { setError(err.message); } 
                finally { setLoading(false); }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <h3>üîë {t.loginTitle}</h3>
                        {error && <div className="error-message">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group"><label>{t.username}</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} required autoFocus /></div>
                            <div className="form-group"><label>{t.password}</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} required /></div>
                            <div className="modal-buttons">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>{t.cancel}</button>
                                <button type="submit" className="btn btn-primary" disabled={loading}>{loading ? t.loggingIn : t.login}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function RegisterModal({ onClose, t }) {
            const { login } = useAuth();
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [displayName, setDisplayName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                try { const data = await api('/api/auth/register', { method: 'POST', body: JSON.stringify({ username, password, displayName: displayName || username }) }); login(data.token, data.user); onClose(); } 
                catch (err) { setError(err.message); } 
                finally { setLoading(false); }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <h3>üìù {t.registerTitle}</h3>
                        {error && <div className="error-message">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group"><label>{t.username} *</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} required autoFocus /></div>
                            <div className="form-group"><label>{t.displayName}</label><input type="text" value={displayName} onChange={e => setDisplayName(e.target.value)} placeholder={username || t.yourName} /></div>
                            <div className="form-group"><label>{t.password} *</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} required /></div>
                            <div className="modal-buttons">
                                <button type="button" className="btn btn-secondary" onClick={onClose}>{t.cancel}</button>
                                <button type="submit" className="btn btn-primary" disabled={loading}>{loading ? t.registering : t.register}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function JoinEventPage({ navigate, t }) {
            const [link, setLink] = useState('');
            const [error, setError] = useState('');

            const handleGo = () => {
                let eventId = link.trim();
                if (eventId.includes('/event/')) eventId = eventId.split('/event/')[1].split(/[?#]/)[0];
                if (!eventId) { setError(t.eventNotFound); return; }
                navigate(`/event/${eventId}`);
            };

            return (
                <div className="center-panel">
                    <div className="panel">
                        <h2>üé≠ {t.joinEventTitle}</h2>
                        <p style={{ marginBottom: '1rem', color: 'var(--ink-light)' }}>{t.pasteLink}</p>
                        {error && <div className="error-message">{error}</div>}
                        <div className="form-group"><label>{t.eventLink}</label><input type="text" value={link} onChange={e => setLink(e.target.value)} placeholder="https://... or event ID" onKeyDown={e => e.key === 'Enter' && handleGo()} /></div>
                        <button className="btn btn-primary btn-block" onClick={handleGo}>üöÄ {t.go}</button>
                    </div>
                </div>
            );
        }

        function ProfilePage({ navigate, t }) {
            const { user, setUser } = useAuth();
            const [activeTab, setActiveTab] = useState('profile');
            const [adventurers, setAdventurers] = useState([]);
            const [events, setEvents] = useState({ created: [], participated: [] });
            const [loading, setLoading] = useState(true);
            const [displayName, setDisplayName] = useState(user?.displayName || '');
            const [profileImage, setProfileImage] = useState(user?.profileImage || '');
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [message, setMessage] = useState('');
            const [error, setError] = useState('');
            const [advModal, setAdvModal] = useState(null);
            const [advName, setAdvName] = useState('');
            const [advImage, setAdvImage] = useState('');

            useEffect(() => { if (!user) { navigate('/'); return; } loadData(); }, [user]);

            const loadData = async () => {
                try { const [advData, eventsData] = await Promise.all([api('/api/adventurers'), api('/api/profile/events')]); setAdventurers(advData); setEvents(eventsData); } 
                catch (err) { console.error(err); } 
                finally { setLoading(false); }
            };

            const handleUpdateProfile = async (e) => {
                e.preventDefault(); setError(''); setMessage('');
                try { await api('/api/profile', { method: 'PUT', body: JSON.stringify({ displayName, profileImage }) }); setUser({ ...user, displayName, profileImage }); setMessage(t.profileUpdated); } 
                catch (err) { setError(err.message); }
            };

            const handleChangePassword = async (e) => {
                e.preventDefault(); setError(''); setMessage('');
                try { await api('/api/profile/password', { method: 'PUT', body: JSON.stringify({ currentPassword, newPassword }) }); setCurrentPassword(''); setNewPassword(''); setMessage(t.passwordChanged); } 
                catch (err) { setError(err.message); }
            };

            const openAdvModal = (adv = null) => {
                if (adv) { setAdvName(adv.name); setAdvImage(adv.image || ''); setAdvModal({ mode: 'edit', id: adv.id }); } 
                else { setAdvName(''); setAdvImage(''); setAdvModal({ mode: 'create' }); }
            };

            const saveAdventurer = async () => {
                try {
                    if (advModal.mode === 'create') { const data = await api('/api/adventurers', { method: 'POST', body: JSON.stringify({ name: advName, image: advImage || null }) }); setAdventurers([data, ...adventurers]); } 
                    else { await api(`/api/adventurers/${advModal.id}`, { method: 'PUT', body: JSON.stringify({ name: advName, image: advImage || null }) }); setAdventurers(adventurers.map(a => a.id === advModal.id ? { ...a, name: advName, image: advImage } : a)); }
                    setAdvModal(null);
                } catch (err) { setError(err.message); }
            };

            const deleteAdventurer = async (id) => {
                try { await api(`/api/adventurers/${id}`, { method: 'DELETE' }); setAdventurers(adventurers.filter(a => a.id !== id)); } 
                catch (err) { setError(err.message); }
            };

            if (!user) return null;

            return (
                <div className="center-panel">
                    <div className="panel">
                        <div className="profile-header">
                            {profileImage ? <img src={profileImage} alt="" className="profile-image" /> : <div className="profile-image-placeholder">üë§</div>}
                            <div className="profile-info"><h2>{user.displayName}</h2><p>@{user.username}</p></div>
                        </div>
                        <div className="tabs">
                            <button className={`tab ${activeTab === 'profile' ? 'active' : ''}`} onClick={() => setActiveTab('profile')}>{t.myProfile}</button>
                            <button className={`tab ${activeTab === 'adventurers' ? 'active' : ''}`} onClick={() => setActiveTab('adventurers')}>{t.myAdventurers}</button>
                            <button className={`tab ${activeTab === 'events' ? 'active' : ''}`} onClick={() => setActiveTab('events')}>{t.myQuestBoards}</button>
                        </div>
                        {error && <div className="error-message">{error}</div>}
                        {message && <div className="success-message">{message}</div>}

                        {activeTab === 'profile' && (
                            <>
                                <form onSubmit={handleUpdateProfile}>
                                    <div className="form-group"><label>{t.displayName}</label><input type="text" value={displayName} onChange={e => setDisplayName(e.target.value)} /></div>
                                    <div className="form-group">
                                        <label>{t.profileImage}</label>
                                        <input type="url" value={profileImage} onChange={e => setProfileImage(e.target.value)} placeholder="https://..." />
                                        {profileImage && <div className="image-upload" style={{ marginTop: '0.5rem' }}><img src={profileImage} alt="Preview" className="image-preview" onError={e => e.target.style.display = 'none'} /></div>}
                                    </div>
                                    <button type="submit" className="btn btn-primary">{t.updateProfile}</button>
                                </form>
                                <h3 style={{ marginTop: '2rem', fontFamily: 'Cinzel', borderTop: '1px solid var(--ink-light)', paddingTop: '1rem' }}>üîí {t.changePassword}</h3>
                                <form onSubmit={handleChangePassword}>
                                    <div className="form-group"><label>{t.currentPassword}</label><input type="password" value={currentPassword} onChange={e => setCurrentPassword(e.target.value)} required /></div>
                                    <div className="form-group"><label>{t.newPassword}</label><input type="password" value={newPassword} onChange={e => setNewPassword(e.target.value)} required /></div>
                                    <button type="submit" className="btn btn-secondary">{t.changePassword}</button>
                                </form>
                            </>
                        )}

                        {activeTab === 'adventurers' && (
                            <>
                                <button className="btn btn-primary btn-block" onClick={() => openAdvModal()} style={{ marginBottom: '1rem' }}>‚ûï {t.createAdventurer}</button>
                                {adventurers.length === 0 ? <p style={{ fontStyle: 'italic', color: 'var(--ink-light)' }}>{t.noAdventurersSaved}</p> : adventurers.map(adv => (
                                    <div key={adv.id} className="adventurer-card">
                                        {adv.image ? <img src={adv.image} alt="" /> : <div className="no-image">‚öîÔ∏è</div>}
                                        <div className="info"><div className="name">{adv.name}</div></div>
                                        <div className="actions">
                                            <button className="btn btn-small btn-secondary" onClick={() => openAdvModal(adv)}>‚úèÔ∏è</button>
                                            <button className="btn btn-small btn-danger" onClick={() => deleteAdventurer(adv.id)}>üóëÔ∏è</button>
                                        </div>
                                    </div>
                                ))}
                            </>
                        )}

                        {activeTab === 'events' && (
                            <>
                                <h3 style={{ fontFamily: 'Cinzel', fontSize: '1rem', marginBottom: '0.5rem' }}>üìú {t.createdByMe}</h3>
                                {events.created.length === 0 ? <p style={{ fontStyle: 'italic', color: 'var(--ink-light)', marginBottom: '1rem' }}>‚Äî</p> : events.created.map(ev => (
                                    <a key={ev.id} href={`/event/${ev.id}`} className="event-list-item" onClick={e => { e.preventDefault(); navigate(`/event/${ev.id}`); }}><h4>{ev.name}</h4><p>{ev.dates.length} dates ‚Ä¢ {ev.description || '...'}</p></a>
                                ))}
                                <h3 style={{ fontFamily: 'Cinzel', fontSize: '1rem', marginTop: '1.5rem', marginBottom: '0.5rem' }}>üé≠ {t.participating}</h3>
                                {events.participated.length === 0 ? <p style={{ fontStyle: 'italic', color: 'var(--ink-light)' }}>‚Äî</p> : events.participated.map(ev => (
                                    <a key={ev.id} href={`/event/${ev.id}`} className="event-list-item" onClick={e => { e.preventDefault(); navigate(`/event/${ev.id}`); }}><h4>{ev.name}</h4><p>{ev.dates.length} dates ‚Ä¢ {ev.description || '...'}</p></a>
                                ))}
                            </>
                        )}
                    </div>

                    {advModal && (
                        <div className="modal-overlay" onClick={() => setAdvModal(null)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <h3>‚öîÔ∏è {advModal.mode === 'create' ? t.createAdventurer : t.editAdventurer}</h3>
                                <div className="form-group"><label>{t.adventurerName} *</label><input type="text" value={advName} onChange={e => setAdvName(e.target.value)} autoFocus /></div>
                                <div className="form-group">
                                    <label>{t.adventurerImage}</label>
                                    <input type="url" value={advImage} onChange={e => setAdvImage(e.target.value)} placeholder="https://..." />
                                    <div className="image-upload" style={{ marginTop: '0.5rem' }}>{advImage ? <img src={advImage} alt="Preview" className="image-preview" onError={e => e.target.style.display = 'none'} /> : <div className="image-preview-placeholder">‚öîÔ∏è</div>}</div>
                                </div>
                                <div className="modal-buttons">
                                    <button className="btn btn-secondary" onClick={() => setAdvModal(null)}>{t.cancel}</button>
                                    <button className="btn btn-primary" onClick={saveAdventurer} disabled={!advName.trim()}>{t.save}</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function CreateEventPage({ navigate, t, lang, timeFormat }) {
            const [name, setName] = useState('');
            const [description, setDescription] = useState('');
            const [selectedDates, setSelectedDates] = useState([]);
            const [startHour, setStartHour] = useState(10);
            const [endHour, setEndHour] = useState(22);
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const today = new Date(); today.setHours(0, 0, 0, 0);

            const formatHourOption = (hour) => {
                if (timeFormat === '24') return `${hour.toString().padStart(2, '0')}:00`;
                if (hour === 0) return '12:00 AM';
                if (hour === 12) return '12:00 PM';
                if (hour < 12) return `${hour}:00 AM`;
                return `${hour - 12}:00 PM`;
            };

            const getDaysInMonth = (date) => {
                const year = date.getFullYear(), month = date.getMonth();
                const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
                const days = [];
                for (let i = 0; i < firstDay.getDay(); i++) days.push(null);
                for (let d = 1; d <= lastDay.getDate(); d++) days.push(new Date(year, month, d));
                return days;
            };

            const toggleDate = (date) => {
                if (date < today) return;
                const dateStr = date.toISOString().split('T')[0];
                setSelectedDates(prev => prev.includes(dateStr) ? prev.filter(d => d !== dateStr) : [...prev, dateStr].sort());
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name.trim() || selectedDates.length === 0) { setError(lang === 'sr' ? 'Molimo unesite naziv i izaberite bar jedan datum' : 'Please enter a name and select at least one date'); return; }
                setLoading(true); setError('');
                try { const res = await api('/api/events', { method: 'POST', body: JSON.stringify({ name: name.trim(), description: description.trim(), dates: selectedDates, startHour, endHour }) }); navigate(res.url); } 
                catch (err) { setError(err.message || 'Network error'); } 
                finally { setLoading(false); }
            };

            const days = getDaysInMonth(currentMonth);
            const monthName = t.months[currentMonth.getMonth()] + ' ' + currentMonth.getFullYear();

            return (
                <div className="center-panel">
                    <div className="panel">
                        <h2>üìú {t.createNewQuest}</h2>
                        {error && <div className="error-message">{error}</div>}
                        <form onSubmit={handleSubmit}>
                            <div className="form-group"><label>{t.eventName} *</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder={t.eventNamePlaceholder} required /></div>
                            <div className="form-group"><label>{t.description}</label><textarea value={description} onChange={(e) => setDescription(e.target.value)} placeholder={t.descriptionPlaceholder} rows={2} /></div>
                            <div className="form-group">
                                <label>{t.selectDates} * ({selectedDates.length} {t.selected})</label>
                                <div className="month-nav">
                                    <button type="button" onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1))}>‚óÄ</button>
                                    <span>{monthName}</span>
                                    <button type="button" onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1))}>‚ñ∂</button>
                                </div>
                                <div className="date-picker-grid">
                                    {t.daysShort.map((d, i) => <div key={i} className="date-picker-header">{d}</div>)}
                                    {days.map((date, i) => <div key={i} className={`date-cell ${!date ? 'disabled' : ''} ${date && date < today ? 'disabled' : ''} ${date && selectedDates.includes(date.toISOString().split('T')[0]) ? 'selected' : ''}`} onClick={() => date && toggleDate(date)}>{date ? date.getDate() : ''}</div>)}
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group"><label>{t.startTime}</label><select value={startHour} onChange={(e) => setStartHour(Number(e.target.value))}>{Array.from({length: 24}, (_, i) => <option key={i} value={i}>{formatHourOption(i)}</option>)}</select></div>
                                <div className="form-group"><label>{t.endTime}</label><select value={endHour} onChange={(e) => setEndHour(Number(e.target.value))}>{Array.from({length: 24}, (_, i) => <option key={i} value={i}>{formatHourOption(i)}</option>)}</select></div>
                            </div>
                            <button type="submit" className="btn btn-primary btn-block" disabled={loading}>{loading ? t.creating : `‚öîÔ∏è ${t.createQuestBoard}`}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function EventPage({ eventId, t, lang, timeFormat }) {
            const { user } = useAuth();
            const [event, setEvent] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [currentUser, setCurrentUser] = useState('');
            const [currentUserImage, setCurrentUserImage] = useState('');
            const [userSlots, setUserSlots] = useState({});
            const [viewMode, setViewMode] = useState('group');
            const [tooltip, setTooltip] = useState(null);
            const [noteModal, setNoteModal] = useState(null);
            const [tempNote, setTempNote] = useState('');
            const [nameModal, setNameModal] = useState(false);
            const [tempName, setTempName] = useState('');
            const [showSaved, setShowSaved] = useState(false);
            const [copied, setCopied] = useState(false);
            const [adventurers, setAdventurers] = useState([]);
            const [selectedAdventurer, setSelectedAdventurer] = useState(null);
            const [isDragging, setIsDragging] = useState(false);
            const [dragMode, setDragMode] = useState(null);
            const [draggedSlots, setDraggedSlots] = useState(new Set());

            useEffect(() => { fetchEvent(); if (user) fetchAdventurers(); }, [eventId, user]);

            const fetchEvent = async () => {
                try {
                    const data = await api(`/api/events/${eventId}`);
                    setEvent(data);
                    const savedUser = localStorage.getItem(`quest-board-user-${eventId}`);
                    const savedImage = localStorage.getItem(`quest-board-user-image-${eventId}`);
                    if (savedUser && data.participants.includes(savedUser)) { setCurrentUser(savedUser); setCurrentUserImage(savedImage || ''); setUserSlots(data.availability[savedUser] || {}); }
                } catch (err) { setError(t.eventNotFound); } finally { setLoading(false); }
            };

            const fetchAdventurers = async () => { try { const data = await api('/api/adventurers'); setAdventurers(data); } catch {} };

            const saveAvailability = async (slots) => {
                if (!currentUser) return;
                try { await api(`/api/events/${eventId}/availability`, { method: 'POST', body: JSON.stringify({ participantName: currentUser, participantImage: currentUserImage || null, slots }) }); await fetchEvent(); setShowSaved(true); setTimeout(() => setShowSaved(false), 2000); } 
                catch (err) { console.error('Failed to save:', err); }
            };

            const handleJoin = () => {
                let name, image;
                if (selectedAdventurer) { name = selectedAdventurer.name; image = selectedAdventurer.image || ''; } 
                else { name = tempName.trim(); image = ''; }
                if (!name) return;
                setCurrentUser(name); setCurrentUserImage(image);
                localStorage.setItem(`quest-board-user-${eventId}`, name);
                localStorage.setItem(`quest-board-user-image-${eventId}`, image);
                if (event.availability[name]) setUserSlots(event.availability[name]); else setUserSlots({});
                setNameModal(false); setTempName(''); setSelectedAdventurer(null); setViewMode('edit');
            };

            const handleMouseDown = (date, hour, e) => {
                if (viewMode !== 'edit' || !currentUser || e.button !== 0) return;
                e.preventDefault();
                const key = getSlotKey(date, hour);
                setIsDragging(true); setDragMode(userSlots[key]?.available ? 'remove' : 'add'); setDraggedSlots(new Set([key]));
            };

            const handleMouseEnter = (date, hour) => { if (!isDragging || viewMode !== 'edit') return; setDraggedSlots(prev => new Set([...prev, getSlotKey(date, hour)])); };

            const handleMouseUp = () => {
                if (!isDragging) return;
                const newSlots = { ...userSlots };
                draggedSlots.forEach(key => { if (dragMode === 'add') newSlots[key] = { available: true, note: '' }; else delete newSlots[key]; });
                setUserSlots(newSlots); saveAvailability(newSlots);
                setIsDragging(false); setDragMode(null); setDraggedSlots(new Set());
            };

            useEffect(() => { const handler = () => { if (isDragging) handleMouseUp(); }; window.addEventListener('mouseup', handler); return () => window.removeEventListener('mouseup', handler); }, [isDragging, dragMode, draggedSlots, userSlots]);

            const openNoteModal = (date, hour, e) => { e.preventDefault(); e.stopPropagation(); if (viewMode !== 'edit' || !currentUser) return; const key = getSlotKey(date, hour); if (!userSlots[key]?.available) return; setTempNote(userSlots[key]?.note || ''); setNoteModal({ date, hour }); };

            const saveNote = () => { if (!noteModal) return; const key = getSlotKey(noteModal.date, noteModal.hour); const newSlots = { ...userSlots }; if (newSlots[key]) newSlots[key] = { ...newSlots[key], note: tempNote }; setUserSlots(newSlots); saveAvailability(newSlots); setNoteModal(null); setTempNote(''); };

            const getSlotAvailability = (date, hour) => { if (!event) return []; const key = getSlotKey(date, hour); return event.participants.filter(name => event.availability[name]?.[key]?.available).map(name => ({ name, note: event.availability[name][key].note || '', image: event.participantImages?.[name] || '' })); };

            const getSlotClass = (date, hour) => {
                const key = getSlotKey(date, hour);
                if (isDragging && draggedSlots.has(key)) return dragMode === 'add' ? 'dragging' : 'empty';
                if (viewMode === 'edit') return userSlots[key]?.available ? 'available' : 'empty';
                const available = getSlotAvailability(date, hour);
                const ratio = available.length / (event.participants.length || 1);
                if (ratio === 0) return 'empty'; if (ratio < 0.2) return 'level-1'; if (ratio < 0.4) return 'level-2'; if (ratio < 0.6) return 'level-3'; if (ratio < 0.8) return 'level-4'; return 'level-5';
            };

            const hasNote = (date, hour) => { const key = getSlotKey(date, hour); if (viewMode === 'edit') return (userSlots[key]?.note || '').length > 0; return getSlotAvailability(date, hour).some(a => a.note.length > 0); };
            const handleSlotHover = (e, date, hour) => { const rect = e.target.getBoundingClientRect(); setTooltip({ x: Math.min(rect.right + 10, window.innerWidth - 300), y: Math.min(rect.top, window.innerHeight - 200), date, hour, available: getSlotAvailability(date, hour) }); };
            const copyLink = () => { navigator.clipboard.writeText(window.location.href); setCopied(true); setTimeout(() => setCopied(false), 2000); };

            const formatHour = (hour) => { if (timeFormat === '24') return { hour: hour.toString().padStart(2, '0') + ':00', ampm: '' }; if (hour === 0) return { hour: '12', ampm: 'AM' }; if (hour === 12) return { hour: '12', ampm: 'PM' }; if (hour < 12) return { hour: hour.toString(), ampm: 'AM' }; return { hour: (hour - 12).toString(), ampm: 'PM' }; };
            const formatDateForDisplay = (dateStr) => { const date = new Date(dateStr + 'T12:00:00'); return { dayName: t.days[date.getDay()], dayNum: t.ordinal(date.getDate()) }; };
            const formatTooltipDate = (dateStr, hour) => { const date = new Date(dateStr + 'T12:00:00'); const h = formatHour(hour); return `${t.days[date.getDay()]}, ${t.months[date.getMonth()]} ${t.ordinal(date.getDate())} ${t.atTime} ${timeFormat === '24' ? h.hour : `${h.hour} ${h.ampm}`}`; };
            const groupDatesByMonth = (dates) => { const groups = []; let cur = null; dates.forEach((ds, i) => { const d = new Date(ds + 'T12:00:00'); const k = `${d.getFullYear()}-${d.getMonth()}`; if (!cur || cur.key !== k) { cur = { key: k, name: t.months[d.getMonth()], count: 1 }; groups.push(cur); } else cur.count++; }); return groups; };

            if (loading) return <div className="panel loading">üé≤ {t.loadingDice}</div>;
            if (error) return <div className="panel"><div className="error-message">{error}</div></div>;

            const hours = []; for (let h = event.startHour; h < event.endHour; h++) hours.push(h);
            const monthGroups = groupDatesByMonth(event.dates);

            return (
                <>
                    <div className="main-content">
                        <aside className="panel">
                            <h2>‚öîÔ∏è {t.adventurer}</h2>
                            {!currentUser ? (
                                <><p style={{marginBottom: '1rem', fontStyle: 'italic'}}>{t.joinPrompt}</p><button className="btn btn-primary btn-block" onClick={() => setNameModal(true)}>üé≠ {t.joinQuest}</button></>
                            ) : (
                                <>
                                    <div className="participant-tag active" style={{marginBottom: '1rem'}}>{currentUserImage && <img src={currentUserImage} alt="" />}{currentUser}</div>
                                    <div className="view-toggle">
                                        <button className={`btn ${viewMode === 'group' ? 'active' : 'btn-secondary'}`} onClick={() => setViewMode('group')}>üë• {t.group}</button>
                                        <button className={`btn ${viewMode === 'edit' ? 'active' : 'btn-secondary'}`} onClick={() => setViewMode('edit')}>‚úèÔ∏è {t.edit}</button>
                                    </div>
                                    {viewMode === 'edit' && <div className="instructions"><strong>{t.instructionsTitle}</strong><ul><li>{t.instruction1}</li><li>{t.instruction2}</li><li>{t.instruction3}</li></ul></div>}
                                </>
                            )}
                            <h2 style={{marginTop: '1.5rem'}}>üé≠ {t.party} ({event.participants.length})</h2>
                            <div>{event.participants.length === 0 ? <p style={{fontStyle: 'italic', fontSize: '0.9rem'}}>{t.noAdventurers}</p> : event.participants.map(name => <span key={name} className={`participant-tag ${name === currentUser ? 'active' : ''}`}>{event.participantImages?.[name] && <img src={event.participantImages[name]} alt="" />}{name}</span>)}</div>
                            <div className="share-box"><strong>üì® {t.inviteParty}</strong><span className="share-url">{window.location.href}</span><button className="btn btn-secondary" onClick={copyLink}>{copied ? `‚úì ${t.copied}` : `üìã ${t.copyLink}`}</button></div>
                            <div className="legend">{viewMode === 'group' ? <><div className="legend-item"><div className="legend-color" style={{background: 'var(--available)'}}></div><span>{t.all}</span></div><div className="legend-item"><div className="legend-color" style={{background: '#7bc47a'}}></div><span>{t.most}</span></div><div className="legend-item"><div className="legend-color" style={{background: '#a8d5a2'}}></div><span>{t.some}</span></div></> : <div className="legend-item"><div className="legend-color" style={{background: 'var(--available)'}}></div><span>{t.available}</span></div>}<div className="legend-item"><span>üìú</span><span>{t.hasNote}</span></div></div>
                        </aside>
                        <main className="panel">
                            <h2>üìÖ {event.name}</h2>
                            {event.description && <p style={{marginBottom: '1rem', fontStyle: 'italic'}}>{event.description}</p>}
                            <div className="schedule-grid">
                                <div className="grid-container" style={{ gridTemplateColumns: `60px repeat(${event.dates.length}, 1fr)`, marginBottom: '2px' }}>
                                    <div style={{background: 'transparent'}}></div>
                                    {monthGroups.map(g => <div key={g.key} className="month-header" style={{ gridColumn: `span ${g.count}` }}>{g.name}</div>)}
                                </div>
                                <div className="grid-container" style={{ gridTemplateColumns: `60px repeat(${event.dates.length}, 1fr)`, gridTemplateRows: `auto repeat(${hours.length}, 1fr)` }}>
                                    <div style={{background: 'transparent'}}></div>
                                    {event.dates.map(date => { const { dayName, dayNum } = formatDateForDisplay(date); return <div key={date} className="grid-header"><span className="day-name">{dayName}</span><span className="day-number">{dayNum}</span></div>; })}
                                    {hours.map(hour => { const { hour: hourStr, ampm } = formatHour(hour); return (
                                        <React.Fragment key={hour}>
                                            <div className="time-label"><span className="hour">{hourStr}</span>{ampm && <span className="ampm">{ampm}</span>}</div>
                                            {event.dates.map(date => <div key={`${date}-${hour}`} className={`time-slot ${getSlotClass(date, hour)} ${hasNote(date, hour) ? 'has-note' : ''}`} onMouseDown={(e) => handleMouseDown(date, hour, e)} onMouseEnter={() => handleMouseEnter(date, hour)} onContextMenu={(e) => openNoteModal(date, hour, e)} onMouseOver={(e) => !isDragging && handleSlotHover(e, date, hour)} onMouseLeave={() => !isDragging && setTooltip(null)}>{viewMode === 'group' && getSlotAvailability(date, hour).length > 0 && <span className="availability-count">{getSlotAvailability(date, hour).length}</span>}</div>)}
                                        </React.Fragment>
                                    ); })}
                                </div>
                            </div>
                        </main>
                    </div>

                    {tooltip && !isDragging && <div className="tooltip" style={{ left: tooltip.x, top: tooltip.y }}><h4>{formatTooltipDate(tooltip.date, tooltip.hour)}</h4>{tooltip.available.length === 0 ? <p style={{fontStyle: 'italic'}}>{t.noOneAvailable}</p> : tooltip.available.map((a, i) => <div key={i} className="tooltip-entry"><div className="tooltip-name">{a.name}</div>{a.note && <div className="tooltip-note">"{a.note}"</div>}</div>)}</div>}

                    {nameModal && (
                        <div className="modal-overlay" onClick={() => setNameModal(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <h3>üé≠ {t.enterName}</h3>
                                {user && adventurers.length > 0 && (
                                    <>
                                        <p style={{marginBottom: '0.5rem', fontWeight: '600'}}>{t.selectAdventurer}</p>
                                        {adventurers.map(adv => <div key={adv.id} className="adventurer-card" style={{ cursor: 'pointer', border: selectedAdventurer?.id === adv.id ? '2px solid var(--gold)' : undefined }} onClick={() => { setSelectedAdventurer(adv); setTempName(''); }}>{adv.image ? <img src={adv.image} alt="" /> : <div className="no-image">‚öîÔ∏è</div>}<div className="info"><div className="name">{adv.name}</div></div></div>)}
                                        <p style={{marginTop: '1rem', marginBottom: '0.5rem', color: 'var(--ink-light)', textAlign: 'center'}}>‚Äî {t.orEnterName} ‚Äî</p>
                                    </>
                                )}
                                <p style={{marginBottom: '0.5rem', color: 'var(--ink-light)'}}>{t.howShouldPartyKnow}</p>
                                <div className="form-group"><input type="text" value={tempName} onChange={(e) => { setTempName(e.target.value); setSelectedAdventurer(null); }} placeholder={t.yourName} onKeyDown={(e) => e.key === 'Enter' && handleJoin()} /></div>
                                <div className="modal-buttons">
                                    <button className="btn btn-secondary" onClick={() => setNameModal(false)}>{t.cancel}</button>
                                    <button className="btn btn-primary" onClick={handleJoin} disabled={!tempName.trim() && !selectedAdventurer}>{selectedAdventurer ? t.useAdventurer : t.joinQuest}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {noteModal && (
                        <div className="modal-overlay" onClick={() => setNoteModal(null)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <h3>üìú {t.addNote}</h3>
                                <p style={{marginBottom: '1rem', color: 'var(--ink-light)'}}>{formatTooltipDate(noteModal.date, noteModal.hour)}</p>
                                <div className="form-group"><label>{t.yourNote}</label><textarea value={tempNote} onChange={(e) => setTempNote(e.target.value)} rows={3} placeholder={t.notePlaceholder} autoFocus /></div>
                                <div className="modal-buttons">
                                    <button className="btn btn-secondary" onClick={() => setNoteModal(null)}>{t.cancel}</button>
                                    <button className="btn btn-primary" onClick={saveNote}>{t.saveNote}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showSaved && <div className="saved-indicator">‚úì {t.saved}</div>}
                </>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
